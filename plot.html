<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>História da Mineração no Brasil</title>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
      }
      #controls {
        margin: 20px;
      }
      #map {
        width: 90%;
        height: 600px;
        margin: auto;
      }
    </style>
  </head>
  <body>
    <h2>História da Mineração no Brasil</h2>

    <div id="controls">
      <label for="categoryFilter">Filtrar por categoria:</label>
      <select id="categoryFilter">
        <option value="TODAS">Todas</option>
      </select>
    </div>

    <div id="map"></div>

    <script>
      $(function () {
        const myChart = echarts.init(document.getElementById("map"));
        myChart.showLoading();

        const subsColors = {};
        const allData = {};

        function getColor(subs) {
          if (!subsColors[subs]) {
            const hash = [...subs].reduce(
              (acc, char) => acc + char.charCodeAt(0),
              0
            );
            const hue = hash % 360;
            subsColors[subs] = `hsl(${hue}, 70%, 50%)`;
          }
          return subsColors[subs];
        }

        function updateChart(categoryFilter) {
          const sortedYears = Object.keys(allData);
          const options = sortedYears.map((year) => {
            const yearData = allData[year] || {};
            const subsSeries = [];

            for (const [subs, entries] of Object.entries(yearData)) {
              const filtered =
                categoryFilter === "TODAS"
                  ? entries
                  : entries.filter((d) => d.categoria === categoryFilter);

              if (filtered.length > 0) {
                subsSeries.push({
                  name: subs,
                  type: "scatter",
                  coordinateSystem: "geo",
                  data: filtered,
                  symbolSize: (val) => Math.sqrt(val[2]) * 0.3 + 2,
                  itemStyle: {
                    color: getColor(subs),
                  },
                  emphasis: {
                    scale: true,
                  },
                });
              }
            }

            return {
              title: {
                text: `Mineração no Brasil - ${year}`,
                left: "center",
              },
              series: subsSeries,
            };
          });

          const finalOption = {
            baseOption: {
              timeline: {
                axisType: "category",
                autoPlay: true,
                playInterval: 3000,
                data: sortedYears,
                label: {
                  formatter: (s) => s,
                },
              },
              tooltip: {
                trigger: "item",
                formatter: (params) => {
                  return `
                    Substância: ${params.seriesName}<br/>
                    Área: ${params.value[2]} ha<br/>
                    Extrator: ${params.value[3]}
                  `;
                },
              },
              geo: {
                map: "Brazil",
                roam: true,
                scaleLimit: {
                  min: 1,
                  max: 10,
                },
                emphasis: {
                  label: {
                    show: false,
                  },
                },
              },
              legend: {
                orient: "vertical",
                right: 10,
                top: "middle",
                textStyle: {
                  fontSize: 12,
                },
              },
              series: [],
            },
            options: options,
          };

          myChart.clear();
          myChart.setOption(finalOption);
        }

        $.get(
          "https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/brazil-states.geojson",
          function (brazilJson) {
            echarts.registerMap("Brazil", brazilJson);
            myChart.hideLoading();

            $.get(
              "https://raw.githubusercontent.com/Jaovicttor/vdd-prova3/v1/df_vdd.csv",
              function (csvData) {
                const lines = csvData.split("\n");
                const header = lines[0].split(",");

                const yearIndex = header.indexOf("ANO");
                const subsIndex = header.indexOf("SUBS");
                const wktIndex = header.indexOf("WKT");
                const areaIndex = header.indexOf("AREA_HA");
                const catIndex = header.indexOf("CATEGORIA");
                const companyIndex = header.indexOf("NOME");

                const categorySet = new Set();

                for (let i = 1; i < lines.length; i++) {
                  const cols = lines[i].split(",");
                  if (cols.length < 6) continue;

                  const subs = cols[subsIndex]?.trim().toUpperCase();
                  const wkt = cols[wktIndex];
                  const area = parseFloat(cols[areaIndex]) || 0;
                  const year = cols[yearIndex]?.trim();
                  const categoria = cols[catIndex]?.trim();
                  const company = cols[companyIndex]?.trim();
                  if (!year || !subs || !categoria) continue;

                  const match = wkt.match(
                    /POINT \((-?\d+\.\d+) (-?\d+\.\d+)\)/
                  );
                  if (match) {
                    const longitude = parseFloat(match[1]);
                    const latitude = parseFloat(match[2]);

                    if (!allData[year]) allData[year] = {};
                    if (!allData[year][subs]) allData[year][subs] = [];

                    allData[year][subs].push({
                      value: [longitude, latitude, area, company],
                      categoria: categoria,
                    });

                    categorySet.add(categoria);
                  }
                }

                // Atualiza o seletor de categoria
                const select = document.getElementById("categoryFilter");
                categorySet.forEach((cat) => {
                  const option = document.createElement("option");
                  option.value = cat;
                  option.textContent = cat;
                  select.appendChild(option);
                });

                // Evento de filtro
                select.addEventListener("change", (e) => {
                  updateChart(e.target.value);
                });

                // Primeiro render
                updateChart("TODAS");
              }
            );
          }
        );
      });
    </script>
  </body>
</html>
